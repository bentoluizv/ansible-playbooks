---
# DevSec Postgres Baseline: https://dev-sec.io/baselines/postgres/
# Configures postgresql.conf hardening

- name: Harden PostgreSQL configuration (DevSec)
  hosts: all
  become: yes
  vars:
    postgres_ssl_enable: false

  handlers:
    - name: Restart PostgreSQL
      systemd:
        name: postgresql
        state: restarted

  tasks:
    - name: Check if PostgreSQL is installed
      command: psql --version
      register: pg_check
      changed_when: false
      failed_when: false

    - name: Find PostgreSQL config directory
      find:
        paths: /etc/postgresql
        patterns: postgresql.conf
      register: pg_conf_find
      when: pg_check.rc == 0

    - name: Set postgres config paths
      set_fact:
        postgres_conf_dir: "{{ (pg_conf_find.files | default([]) | first).path | dirname }}"
      when:
        - pg_check.rc == 0
        - (pg_conf_find.files | default([]) | length) > 0

    - name: Ensure conf.d exists
      file:
        path: "{{ postgres_conf_dir }}/conf.d"
        state: directory
        owner: postgres
        group: postgres
        mode: '0700'
      when: postgres_conf_dir is defined

    - name: Deploy hardening config (postgres-07, postgres-16)
      template:
        src: postgresql-hardening.conf.j2
        dest: "{{ postgres_conf_dir }}/conf.d/99-hardening.conf"
        owner: postgres
        group: postgres
        mode: '0600'
      when: postgres_conf_dir is defined
      notify: Restart PostgreSQL

    - name: Ensure include_dir is set in postgresql.conf
      lineinfile:
        path: "{{ postgres_conf_dir }}/postgresql.conf"
        regexp: "^\s*#?\s*include_dir\s*="
        line: "include_dir = 'conf.d'"
        insertafter: "^data_directory"
      when: postgres_conf_dir is defined
      notify: Restart PostgreSQL
