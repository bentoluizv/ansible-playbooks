---
# DevSec Kubernetes Configuration Audit
# Run: ansible-playbook playbooks/audit/kubernetes.yml

- name: DevSec Kubernetes Configuration Audit
  hosts: all
  become: yes

  vars:
    k8s_manifest_paths:
      - /etc/kubernetes/manifests/kube-apiserver.yaml
      - /etc/kubernetes/manifests/kube-controller-manager.yaml
      - /etc/kubernetes/manifests/kube-scheduler.yaml
      - /etc/kubernetes/manifests/etcd.yaml
    k8s_conf_paths:
      - /etc/kubernetes/admin.conf
      - /etc/kubernetes/scheduler.conf
      - /etc/kubernetes/controller-manager.conf
      - /etc/kubernetes/kubelet.conf

  tasks:
    - name: Check if /etc/kubernetes exists
      stat:
        path: /etc/kubernetes
      register: k8s_dir

    - name: Verify manifest files are root:root (CIS 1.1.1-1.1.8)
      stat:
        path: "{{ item }}"
      register: manifest_stats
      loop: "{{ k8s_manifest_paths }}"
      when: k8s_dir.stat.exists

    - name: Assert manifest ownership root:root
      assert:
        that:
          - item.stat.uid == 0
          - item.stat.gid == 0
        fail_msg: "{{ item.item }} must be owned by root:root"
      loop: "{{ manifest_stats.results }}"
      when: item.stat is defined and item.stat.exists | default(false)

    - name: Verify kubeconfig files are root:root (CIS 1.1.13-1.1.18)
      stat:
        path: "{{ item }}"
      register: conf_stats
      loop: "{{ k8s_conf_paths }}"
      when: k8s_dir.stat.exists

    - name: Assert kubeconfig ownership root:root
      assert:
        that:
          - item.stat.uid == 0
          - item.stat.gid == 0
        fail_msg: "{{ item.item }} must be owned by root:root"
      loop: "{{ conf_stats.results }}"
      when: item.stat is defined and item.stat.exists | default(false)

    - name: Verify PKI key files are 600 (CIS 1.1.21)
      find:
        paths: /etc/kubernetes/pki
        patterns: "*.key"
      register: pki_keys
      when: k8s_dir.stat.exists

    - name: Assert PKI key permissions 600 (CIS 1.1.21)
      assert:
        that: item.mode == "0600" or ((item.mode | int) & 511) == 384
        fail_msg: "{{ item.path }} must have mode 600"
      loop: "{{ pki_keys.files | default([]) }}"
      when: k8s_dir.stat.exists and pki_keys.files | default([]) | length > 0
